{% extends 'base.html' %}
{% load static %}

{% block title %}
O'zBilim | {{ article.title }}
{% endblock title %}

{% block main %}
<!-- Author Info -->
<div class="author-box">
    <img src="{% if article.author.avatar %}{{ article.author.avatar.url }}{% else %}{% static 'uploads/image.png' %}{% endif %}"
         alt="Muallif">
    <div>
        <div class="fw-bold">{{ article.author.first_name }} {{ article.author.last_name }} {% if article.author.is_verified %}<span class="verified-badge"><i
                    class="bi bi-patch-check-fill"></i></span>{% endif %}
        </div>
        <div class="username"><a href="{% url 'profile' article.author.username %}">@{{ article.author.username }}</a>
        </div>
    </div>
</div>

<h2 class="mb-4 text-primary">{{ article.title }}</h2>

<!-- Image Carousel Gallery -->
{% if article.images.exists %}
<div id="galleryCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
    <div class="carousel-inner">
        {% for image in article.images.all %}
        <div class="carousel-item {% if forloop.first %}active{% endif %}">
            <img src="{{ image.image.url }}"
                 class="d-block w-100" alt="image - {{ forloop.counter }}">
        </div>
        {% endfor %}
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#galleryCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Oldingi</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#galleryCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Keyingi</span>
    </button>
</div>
{% endif %}

<!-- Article Content -->
<div class="article-text">
    <p>{{ article.content|linebreaksbr }}</p>

    <div class="d-flex justify-content-between mt-4 pt-2 border-top">
        <small class="text-muted">Joylangan sana: {{ article.created_at }}</small>
        <div class="views-info text-muted">
            <i class="bi bi-eye me-1 text-primary"></i> {{ article.views }} marta
        </div>
    </div>
</div>

<!-- COMMENT SECTION -->
<div class="article-text mt-5">
    <h5 class="mb-4 text-primary">Izohlar</h5>

    <!-- Comment Form -->
    {% if request.user.is_authenticated %}
    <form class="mb-4" method="post" action="{% url 'comment' article.pk %}">
        {% csrf_token %}
        <div class="mb-3">
            {% for field in form %}
            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
            {{ field }}
            {% endfor %}
        </div>
        <button type="submit" class="btn btn-primary">Yuborish</button>
    </form>
    {% endif %}

    <!-- Comment List -->
    <div class="mb-4 p-3 bg-white rounded shadow-sm">
        {% if comments %}
        {% for comment in comments %}
        <div class="comment d-flex mb-3">
            <img src="{% if comment.user.avatar %}{{ comment.user.avatar.url }}{% else %}{% static 'uploads/image.png' %}{% endif %}"
                 class="rounded-circle me-3" width="48" height="48" alt="User">

            <div class="flex-grow-1">
                <div class="fw-bold d-flex justify-content-between">
            <span>
                {{ comment.user.get_full_name }}
                {% if comment.user.is_verified %}
                    <span class="verified-badge"><i class="bi bi-patch-check-fill"></i></span>
                {% endif %}
            </span>

                    {% if request.user == comment.user or article.author == request.user or request.user.is_superuser %}
                    <a href="{% url 'delete-comment' article.pk comment.pk %}" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash"></i> O‘chirish
                    </a>
                    {% endif %}
                </div>
                <small class="text-muted">
                    <a href="{% url 'profile' comment.user.username %}">@{{ comment.user.username }}</a> • {{ comment.created_at|date:"Y-m-d H:i" }}
                </small>
                <p class="mt-2 mb-0">{{ comment.content }}</p>
            </div>
        </div>

        {% endfor %}
        {% else %}
        <div class="text-muted fst-italic">Hozircha hech qanday izoh yozilmagan.</div>
        {% endif %}
    </div>
</div>
{% endblock main %}